#! /bin/sh

sysname='Sundials/ML'
version=5.3.0
versionp=0
contact='tim@tbrk.org'

unset prefix
unset libdir
unset stubdir
unset docdir
unset install_docs
enable_mpi=1
enable_klu=1
enable_superlumt=1
unset enable_debug
unset mathjax
opt_compiler=1
cflags_openmp=
unset mpi_lib_path
unset Lmpi_lib_path
ocaml_tweaks=
other_tweaks=
unset EXAMPLESROOT
debug_configure=false
logfile=/dev/null
bounds_checking=1

configure_command="$0"

for option in "$@"
do
    case "$option" in
        --ignore-envs)
            OCAMLROOT=
            SUNDIALS_DIR=
            SUNDIALS_LIBRARY_DIR=
            SUNDIALS_INCLUDE_DIR=
            SUPERLUMT_DIR=
            SUPERLUMT_INCLUDE_DIR=
            SUPERLUMT_LIBRARY_DIR=
            KLU_INCLUDE_DIR=
            KLU_LIBRARY_DIR=
            LAPACKLIB=
            SUNDIALS_EXAMPLES_DIR=
            OCAMLMPI=
            MPICC=
            MPIRUN=
            MPI_LIBRARY_DIR=
            MATHJAX=
            CFLAGS_OPENMP=
            CC=
            CPP=
            ;;
    esac
done

for option in "$@"
do
    # Try to quote configure_command so that it can be cut-and-pasted to the
    # command line.  Not a perfect solution, but works for common cases.
    configure_command="${configure_command} '$option'"

    name=`expr "$option" : "\([^=]*\).*"`
    value=`expr "$option" : "[^=]*=\(.*\)"`

    case "$name" in
    --prefix)
	prefix="${value%/}/";;
    --libdir)
	libdir="${value%/}/";;
    --stubdir)
	stubdir="${value%/}/";;
    --docdir)
	docdir="${value%/}/";;
    --disable-doc)
	install_docs=0;;
    --disable-mpi)
	enable_mpi=0;;
    --disable-klu)
	enable_klu=0;;
    --disable-superlumt)
	enable_superlumt=0;;
    --enable-debug)
	ocaml_tweaks="${ocaml_tweaks} debug"
	enable_debug=1;;
    --unsafe)
	ocaml_tweaks="${ocaml_tweaks} unsafe"
	bounds_checking=0;;
    --no-opt-compiler) # not meant for users (under normal circumstances)
	opt_compiler=0;;
    --debug-configure)
	debug_configure=true
	logfile="config.debug"
	echo >${logfile};;
    -h|--help)
	cat <<-END_HELP_TEXT
	'configure' configures $sysname ${version}p${versionp} to adapt to many kinds of systems.

	Usage: $0 [OPTION]... [VAR=VALUE]...

	To assign environment variables (e.g., CC, CFLAGS...), specify them as
	VAR=VALUE.  See below for descriptions of some of the useful variables.
	Those variables can be set in the shell to affect all future invocations
	of $0.

	Defaults for the options are specified in brackets.

	Configuration:
	  -h, --help              display this help and exit
	  --ignore-envs           ignore variables set in the shell

	Installation directories:
	  --prefix=PREFIX         install architecture-independent files in PREFIX

	For better control, use the options below.

	Fine tuning of the installation directories:
	  --libdir=DIR           installation directory [OCAML]
	  --stubdir=DIR          stub installation directory [OCAML/stublibs]
	  --docdir=DIR           documentation [PREFIX/share/doc/sundialsml]

	Optional Features:
	  --disable-doc          do not install html documentation
	  --disable-mpi          build without parallel features
	  --disable-klu          build without KLU features
	  --disable-superlumt    build without SuperLU/MT features
	  --no-lib-path          do not record paths in the OCaml library
	  --enable-debug         enable assertions and debug symbols
	  --unsafe               no bounds or other runtime checks

	Influential environment variables:
	  OCAMLROOT             Path to OCaml installation
	  SUNDIALS_DIR          Path to Sundials installation
	  SUNDIALS_LIBRARY_DIR  Path to Sundials libraries (for linking)
	                        (default: \$SUNDIALS_DIR/lib)
	  SUNDIALS_INCLUDE_DIR  Path to Sundials header files (for compiling)
	                        (default: \$SUNDIALS_DIR/include)
	  SUPERLUMT_DIR         Path to SuperLU_MT build files
	  SUPERLUMT_INCLUDE_DIR Path to SuperLU_MT header files
	                        (default: \$SUPERLUMT_DIR/SRC)
	  SUPERLUMT_LIBRARY_DIR Path to SuperLU_MT libraries
	                        (default: \$SUPERLUMT_DIR/lib)
	  KLU_INCLUDE_DIR       Path to KLU (SuiteSparse) header files
	  KLU_LIBRARY_DIR       Path to KLU (SuiteSparse) libraries
	  LAPACKLIB             Command for linking with Lapack (default: -llapack)
	                        (sometimes also: -lSimTKlapack)
	  SUNDIALS_EXAMPLES_DIR Path to installed examples (for comparison with Sundials)
	                        (default: \$SUNDIALS_DIR/examples)
	  OCAMLMPI              Path to OCamlMPI installation
	  CFLAGS_OPENMP         Compiler flag to enable OpenMP compilation
	  MPICC                 Name of the MPI compiler (default: mpicc)
	  MPIRUN                Name of MPI program launcher (default: mpirun)
	  MPI_LIBRARY_DIR       Path to include for MPI libraries (optional)
	  MATHJAX               Local or remote directory containing MathJax.js
	                        (e.g., MATHJAX=/usr/share/javascript/mathjax)
	  OCAML_GRAPHICS	Path to OCaml graphics library (for some examples)

	Set these options by passing arguments of the form FOO=value to help
	configure find libraries and programs with nonstandard names/locations.

	Report bugs to <$contact>.

END_HELP_TEXT
	exit 0
	;;
    --ignore-envs)
        : # Handled above.
        ;;
    OCAMLROOT)
	OCAMLROOT="${value}";;
    SUNDIALS_DIR)
	SUNDIALS_DIR="${value}";;
    SUNDIALS_LIBRARY_DIR)
	SUNDIALS_LIBRARY_DIR="${value}";;
    SUNDIALS_INCLUDE_DIR)
	SUNDIALS_INCLUDE_DIR="${value}";;
    SUPERLUMT_DIR)
	SUPERLUMT_DIR="${value}";;
    SUPERLUMT_LIBRARY_DIR)
	SUPERLUMT_LIBRARY_DIR="${value}";;
    SUPERLUMT_INCLUDE_DIR)
	SUPERLUMT_INCLUDE_DIR="${value}";;
    KLU_LIBRARY_DIR)
	KLU_LIBRARY_DIR="${value}";;
    KLU_INCLUDE_DIR)
	KLU_INCLUDE_DIR="${value}";;
    CFLAGS_OPENMP)
        CFLAGS_OPENMP="${value}";;
    LAPACKLIB)
	LAPACKLIB="${value}";;
    SUNDIALS_EXAMPLES_DIR)
	SUNDIALS_EXAMPLES_DIR="${value}";;
    CPPFLAGS)
	CPPFLAGS="${value}";;
    CFLAGS)
	CFLAGS="${value}";;
    LDFLAGS)
	LDFLAGS="${value}";;
    OCAMLMPI)
	OCAMLMPI="${value}";;
    OCAMLFLAGS)
	OCAMLFLAGS="${value}";;
    OCAMLOPTFLAGS)
	OCAMLOPTFLAGS="${value}";;
    OCAMLMKLIBFLAGS)
	OCAMLMKLIBFLAGS="${value}";;
    MPICC)
	MPICC="${value}";;
    MPIRUN)
	MPIRUN="${value}";;
    MPI_LIBRARY_DIR)
	MPI_LIBRARY_DIR="${value}";;
    MATHJAX)
	MATHJAX="${value}";;
    OCAML_GRAPHICS)
	OCAML_GRAPHICS="${value%/}";;
    *)
	printf "illegal option \"%s\".\n" "$option" 1>&2; exit 2;;
    esac
done

if [ -f /etc/debian_version ]; then
    distribution=debian
elif [ -f /etc/centos-release ]; then
    distribution=centos
elif [ -f /etc/gentoo-release ]; then
    distribution=gentoo
elif [ -f /etc/fedora-release ]; then
    distribution=fedora
elif [ -f /etc/arch-release ]; then
    distribution=arch
elif [ -f /etc/alpine-release ]; then
    distribution=alpine
else
    distribution=unknown
fi

if [ x"${OCAMLROOT}" != x ]; then
    OCAMLBIN="${OCAMLROOT%/}/bin/"
fi
if [ x"${SUNDIALS_LIBRARY_DIR}" != x ]; then
    sundials_lib_path="${SUNDIALS_LIBRARY_DIR%/}"
    Lsundials_lib_path="-L${sundials_lib_path}"
fi
if [ x"${SUNDIALS_INCLUDE_DIR}" != x ]; then
    sundials_inc_path="${SUNDIALS_INCLUDE_DIR%/}"
    Isundials_inc_path="-I${sundials_inc_path}"
fi
if [ x"${SUNDIALS_DIR}" != x ]; then
    if [ "x${sundials_lib_path}" = x ]; then
	sundials_lib_path="${SUNDIALS_DIR%/}/lib/"
	Lsundials_lib_path="-L${sundials_lib_path}"
    fi
    if [ "x${sundials_inc_path}" = x ]; then
	sundials_inc_path="${SUNDIALS_DIR%/}/include/"
	Isundials_inc_path="-I${sundials_inc_path}"
    fi
    if [ x"${SUNDIALS_EXAMPLES_DIR}" = x ]; then
	SUNDIALS_EXAMPLES_DIR="${SUNDIALS_DIR%/}/examples/"
    fi
fi
if [ x"${SUNDIALS_EXAMPLES_DIR}" != x ]; then
    if [ ! -d "${SUNDIALS_EXAMPLES_DIR%/}/cvode/serial" ]; then
	msg="ignoring invalid examples directory (${SUNDIALS_EXAMPLES_DIR%})"
	warning="${warning}\n\t${msg}"
	SUNDIALS_EXAMPLES_DIR=
    else
	EXAMPLESROOT="${SUNDIALS_EXAMPLES_DIR%/}"
    fi
fi
if [ x"${SUNDIALS_EXAMPLES_DIR}" = x -a "${distribution}" = debian ]; then
    if [ -d "/usr/share/doc/libsundials-serial-dev/examples/cvode/serial" ]; then
	EXAMPLESROOT=/usr/share/doc/libsundials-serial-dev/examples
    elif [ -d "/usr/share/doc/libsundials-dev/examples/cvode/serial" ]; then
	EXAMPLESROOT=/usr/share/doc/libsundials-dev/examples
    fi
fi
if [ x"${SUPERLUMT_DIR}" != x ]; then
    if [ x"${SUPERLUMT_INCLUDE_DIR}" = x ]; then
	SUPERLUMT_INCLUDE_DIR="${SUPERLUMT_DIR%/}/SRC"
    fi
    if [ x"${SUPERLUMT_LIBRARY_DIR}" = x ]; then
	SUPERLUMT_LIBRARY_DIR="${SUPERLUMT_DIR%/}/lib"
    fi
fi
if [ x"${SUPERLUMT_INCLUDE_DIR}" != x ]; then
    superlumt_inc_path="${SUPERLUMT_INCLUDE_DIR%/}"
    Isuperlumt_inc_path="-I${superlumt_inc_path}"
elif [ "${distribution}" = centos ]; then
    superlumt_inc_path="/usr/include/SuperLUMT/"
    Isuperlumt_inc_path="-I${superlumt_inc_path}"
fi
if [ x"${SUPERLUMT_LIBRARY_DIR}" != x ]; then
    superlumt_lib_path="${SUPERLUMT_LIBRARY_DIR%/}"
    Lsuperlumt_lib_path="-L${superlumt_lib_path}"
fi
if [ x"${KLU_INCLUDE_DIR}" != x ]; then
    klu_inc_path="${KLU_INCLUDE_DIR%/}"
    Iklu_inc_path="-I${klu_inc_path}"
elif [ "${distribution}" = debian ] || [ "${distribution}" = centos ]; then
    klu_inc_path="/usr/include/suitesparse/"
    Iklu_inc_path="-I${klu_inc_path}"
fi
if [ x"${KLU_LIBRARY_DIR}" != x ]; then
    klu_lib_path="${KLU_LIBRARY_DIR%/}"
    Lklu_lib_path="-L${klu_lib_path}"
fi
if [ x"${CFLAGS_OPENMP}" != x ]; then
    cflags_openmp="${CFLAGS_OPENMP}"
fi
if [ x"${CPPFLAGS}" != x ]; then
    cppflags="${CPPFLAGS}"
fi
if [ x"${CFLAGS}" != x ]; then
    cflags="${CFLAGS}"
fi
if [ x"${LDFLAGS}" != x ]; then
    ldflags="${LDFLAGS}"
fi
if [ x"${OCAMLFLAGS}" != x ]; then
    ocamlflags="${OCAMLFLAGS}"
fi
if [ x"${OCAMLOPTFLAGS}" != x ]; then
    ocamloptflags="${OCAMLOPTFLAGS}"
fi
if [ x"${OCAMLMKLIBFLAGS}" != x ]; then
    ocamlmklibflags="${OCAMLMKLIBFLAGS}"
fi
if [ x"${MPICC}" != x ]; then
    mpicc="${MPICC}"
fi
if [ x"${MPIRUN}" != x ]; then
    mpirun="${MPIRUN}"
fi
if [ x"${MPI_LIBRARY_DIR}" != x ]; then
    mpi_lib_path="${MPI_LIBRARY_DIR%/}"
    Lmpi_lib_path="-L${MPI_LIBRARY_DIR%/}"
fi
if [ x"${MATHJAX}" != x ]; then
    mathjax="${MATHJAX}"
fi

CC=${CC:-cc}
CPP=${CPP:-cpp}
LAPACKLIB=${LAPACKLIB:-"-llapack"}
error=""

if [ "x${prefix}" = x ]; then
    prefix=/usr/local/

    case `uname -s` in
	Darwin)
	    # OS X does not search /usr/local by default.
	    if [ "x${sundials_lib_path}" = x ]; then
		sundials_lib_path="${prefix}lib/"
		Lsundials_lib_path="-L${sundials_lib_path}"
	    fi
	    if [ "x${sundials_inc_path}" = x ]; then
		sundials_inc_path="${prefix}include/"
		Isundials_inc_path="-I${sundials_inc_path}"
	    fi
	    if [ "x${superlumt_lib_path}" = x ]; then
		superlumt_lib_path="${prefix}lib/"
		Lsuperlumt_lib_path="-L${superlumt_lib_path}"
	    fi
	    if [ "x${klu_lib_path}" = x ]; then
		klu_lib_path="${prefix}lib/"
		Lklu_lib_path="-L${klu_lib_path}"
	    fi
    esac
fi

if [ ${bounds_checking} -eq 0 ]; then
    ocamloptflags="-unsafe ${ocamloptflags}"
    ocamlflags="-unsafe ${ocamlflags}"
fi

# C compiler's output file names
if uname -s | grep -q MINGW; then
    XA=.lib
    XO=.obj
    XS=.dll
    XX=.exe
else
    XA=.a
    XO=.o
    XS=.so
    XX=
fi


# Check C compiler: detect gcc and add a default optimization level.
test_stem=__configure_test_file__gcc
test_cmd="$CC -c $test_stem.c"
echo "/* $test_cmd */" > $test_stem.c
echo "#ifndef __GNUC__" >> $test_stem.c
echo "#error not gcc" >> $test_stem.c
echo "#endif" >> $test_stem.c
using_gcc=false
${test_cmd} >>${logfile} 2>&1 && using_gcc=true
${debug_configure} || rm -f ./$test_stem.*
if [ $using_gcc = true ]; then
    c_suppress_warnings=-w
else
    c_suppress_warnings=
fi

if [ "x${cflags}" = x ]; then    # Don't touch CFLAGS if explicitly given.
    if [ $using_gcc = true ]; then
	optflags="-O3"

	# Compiling with -O2 and clang-602.0.49 (Apple LLVM version 6.1.0)
	# Results in a segfault in examples like
	#   cvode/serial/cvKrylovDemo_proc (in denseAddIdentity)
	# due to a miscompilation of sundials_ml.c:c_sundials_realarray2_wrap
	# (The code generated for the loop:
	#      table[0] = (realtype *)(ba->data);
	#      for (j = 1; j < nc; ++j) {
	#	  table[j] = table[j - 1] + nr;
	#      }
	#  is incorrect. To see, add this loop afterward:
	#      for (j = 0; j < nc; ++j)
	#         printf("table[%d] = %p\n", j, table[j]);
	#  TPB was unable to extract a minimum example.)
	if $CC -v 2>&1 | grep -q 'LLVM version 6.1'; then
	    optflags="-O1"
	fi

        if [ "x$enable_debug" = x1 ]; then
            cflags="-O0 -Wall -Werror -g3"
        else
            cflags="$optflags -Wall -Werror "
        fi
    else
        echo "<info> Your C compiler seems to be different from gcc.  Make"
        echo "<info> sure you set optimization flags explicitly with CFLAGS."
    fi
fi

if [ "x$enable_debug" = x1 ]; then
    ocamloptflags="${ocamloptflags} -g"
    ocamlflags="${ocamlflags} -g"
    if [ $using_gcc = true ]; then
        # This case is handled above.
        :
    else
        cflags="${cflags} -g"
    fi
    cppflags="${cppflags}"
else
    cflags="${cflags} -DNDEBUG=1"
    cppflags="${cppflags} -DNDEBUG=1"
fi

arch=`uname -m`
case ${arch} in
    x86_64)
	cflags="${cflags} -fPIC"
	;;
    *)
        :
	;;
esac

ml_cppflags="-P -traditional-cpp"
case `uname -s` in
    Darwin*)
	ml_cppflags="${ml_cppflags} -Wno-invalid-pp-token"
	;;
    *)
	ml_cppflags="${ml_cppflags} -x c"
	;;
esac

# Check for Sundials installation (and version)
include="\"sundials/sundials_config.h\""
query="SUNDIALS_PACKAGE_VERSION"
sundials_version=`printf "#include %s\n%s" "${include}" "${query}" \
		    | ${CPP} ${cppflags} ${Isundials_inc_path} -P 2>>${logfile} \
		    | tail -1 | sed -e 's/ //g' -e 's/"//g'`
if [ x"${sundials_version}" = x ]; then
    sundials_version="UNKNOWN"
    sundials=0
fi
Lsundials_arkode=
arkode_mlobj_main=
arkode_cobj_main=
arkode_mlobj_bbd=
arkode_cobj_bbd=
arkode_cobj_sens=
arkode_subdir=
arkode_enabled=
if [ "${sundials_version}" = "SUNDIALS_PACKAGE_VERSION" ]; then
    query="SUNDIALS_VERSION"
    sundials_version=`printf "#include %s\n%s" "${include}" "${query}" \
			| ${CPP} ${cppflags} ${Isundials_inc_path} \
			    -P 2>>${logfile} \
			| tail -1 | sed -e 's/ //g' -e 's/"//g'`
fi

if [ "${sundials_version}" = "SUNDIALS_VERSION" ]; then
    error="${error}\n\tcould not find sundials_config.h"
    sundials=0
    sundials_version="UNKNOWN"
else
    case "${sundials_version}" in
	[0-1].*.* | 2.[0-4].*)
	    sundials=0
	    error="${error}\n\tsundials >= 2.5.0 required" ;;
	2.5.*) sundials=250;;
	*)  sundials=260
	    Lsundials_arkode=-lsundials_arkode
	    arkode_mlobj_main='arkode/arkode_impl.cmo arkode/arkode.cmo'
	    arkode_cobj_main=arkode/arkode_ml${XO}
	    arkode_mlobj_bbd=arkode/arkode_bbd.cmo
	    arkode_cobj_bbd=arkode/arkode_bbd_ml${XO}
	    arkode_cobj_sens="arkode/arkode_klu_ml${XO} arkode/arkode_superlumt_ml${XO}"
	    arkode_subdir=arkode
	    arkode_enabled=1
	    ;;
    esac
    case "${sundials_version}" in
	2.6.0) sundials=260 ;;
	2.6.1) sundials=261 ;;
	2.6.2) sundials=262 ;;
	2.7.*) sundials=270 ;;
	3.0.*) sundials=300 ;;
	3.1.0) sundials=310 ;;
	3.1.1) sundials=311 ;;
	3.1.*) sundials=312 ;;
	3.2.*) sundials=320 ;;
	4.0.0) sundials=400 ;;
	4.0.1) sundials=401 ;;
	4.0.2) sundials=402 ;;
	4.*)   sundials=410 ;;
	5.0.*) sundials=500 ;;
	5.1.*) sundials=510 ;;
	5.2.*) sundials=520 ;;
	5.*)   sundials=530 ;;
	6.*)   sundials=600 ;;
	7.*)   sundials=700 ;;
	8.*)   sundials=800 ;;
	9.*)   sundials=900 ;;
	*)     sundials=1000 ;;
    esac

    # Make sure realtype has the right size.
    test_stem=__configure_test_file__realtype
    test_cmd="$CC ${Isundials_inc_path} -o ${test_stem}${XX} $test_stem.c"
    cat > $test_stem.c <<EOF
/* ${test_cmd} */
#include <sundials/sundials_types.h>
int main (int argc, char *argv[])
{
  return sizeof (realtype) != sizeof (double);
}
EOF
    if ! eval "${test_cmd}" >>${logfile} 2>&1
    then
        error="${error}\n\tCan't link C code to sundials.  Is sundials installed properly?"
        error="${error}\n\tSaved test code as ${test_stem}.c"
        error="${error}\n\tCompilation command was:"
        error="${error}\n\t${test_cmd}"
    elif ! ./$test_stem$XX
    then
        error="${error}\n\trealtype not defined as double.  Recompile sundials with -DSUNDIALS_PRECISION=double."
    else
	${debug_configure} || rm -f ./$test_stem*
    fi
fi

if [ ${sundials} -ge 600 ]; then
    sundials=0
    error="${error}\n\tsundials <= 5.x required (${sundials_version} is not yet supported)"
elif [ ${sundials} -ge 400 ]; then
    sundials_at_least_4_0_0=1
    sundials_at_least_3_2_0=1
    sundials_at_least_3_1_2=1
    sundials_at_least_3_0=1
    sundials_at_least_2_7=1
    sundials_at_least_2_6=1
    sundials_at_least_2_5=1
elif [ ${sundials} -ge 320 ]; then
    sundials_at_least_3_2_0=1
    sundials_at_least_3_1_2=1
    sundials_at_least_3_0=1
    sundials_at_least_2_7=1
    sundials_at_least_2_6=1
    sundials_at_least_2_5=1
elif [ ${sundials} -ge 312 ]; then
    sundials_at_least_3_1_2=1
    sundials_at_least_3_0=1
    sundials_at_least_2_7=1
    sundials_at_least_2_6=1
    sundials_at_least_2_5=1
elif [ ${sundials} -ge 300 ]; then
    sundials_at_least_3_0=1
    sundials_at_least_2_7=1
    sundials_at_least_2_6=1
    sundials_at_least_2_5=1
elif [ ${sundials} -ge 270 ]; then
    sundials_at_least_2_7=1
    sundials_at_least_2_6=1
    sundials_at_least_2_5=1
elif [ ${sundials} -ge 260 ]; then
    sundials_at_least_2_6=1
    sundials_at_least_2_5=1
elif [ ${sundials} -ge 250 ]; then
    sundials_at_least_2_6=
    sundials_at_least_2_5=1
else
    sundials_at_least_2_6=
    sundials_at_least_2_5=
fi

sundials_indextype=
if [ ${sundials} -ge 300 ]; then
    include="\"sundials/sundials_config.h\""
    query="SUNDIALS_INT64_T"
    sundials_int64_t=`printf "#include %s\n%s" "${include}" "${query}" \
			| ${CPP} ${cppflags} ${Isundials_inc_path} \
			    -P 2>>${logfile} \
			| tail -1 | sed -e 's/ //g' -e 's/"//g'`
    if [ "${sundials_int64_t}" = SUNDIALS_INT64_T ]; then
	sundials_indextype=32
	other_tweaks="${other_tweaks} index-int32"
    else
	sundials_indextype=64
    fi
else
    sundials_indextype=64
fi

# Check for OCaml installation (and version)
ocaml_path=`${OCAMLBIN}ocamlc -where`
ocaml_version=`${OCAMLBIN}ocamlc -version`
if [ $? -ne 0 ]; then
    error="${error}\n\tcould not find ocamlc"
    ocaml_path='NOT FOUND'
    ocaml_version=''
    ocaml_version_info=''
    ocaml_libpath=''
else
    case "${ocaml_version}" in
	[0-3].*.* | 4.00.* | 4.01.* | 4.02.0 | 4.02.1 | 4.02.2)
	    error="${error}\\n\\tocaml >= 4.02.3 required" ;;
	*) ;;
    esac

    ocaml_libpath="${ocaml_path%/}/"
    ocaml_version_info=" (${ocaml_version})"
fi

ocamlflags="${ocamlflags} -bin-annot"
ocamloptflags="${ocamloptflags} -bin-annot"

# Check if .opt variants are available.
if [ "x$opt_compiler" = x1 ] && \
       ([ -x ${OCAMLBIN}ocamlc.opt ] \
        || which ${OCAMLBIN}ocamlc.opt >>${logfile} 2>&1)
then
    ocamlc="${OCAMLBIN}ocamlc.opt"
else
    ocamlc="${OCAMLBIN}ocamlc"
fi

if [ "x$opt_compiler" = x1 ] && \
       ([ -x ${OCAMLBIN}ocamlopt.opt ] \
        || which ${OCAMLBIN}ocamlopt.opt >>${logfile} 2>&1)
then
    ocamlopt="${OCAMLBIN}ocamlopt.opt"
else
    ocamlopt="${OCAMLBIN}ocamlopt"
fi

if [ "x$opt_compiler" = x1 ] && \
       ([ -x ${OCAMLBIN}ocamldoc.opt ] \
        || which ${OCAMLBIN}ocamldoc.opt >>${logfile} 2>&1)
then
    ocamldoc="${OCAMLBIN}ocamldoc.opt"
    ocamldoc_plugin=".cmxs"
else
    ocamldoc="${OCAMLBIN}ocamldoc"
    ocamldoc_plugin=".cma"
fi

if [ "x$opt_compiler" = x1 ] && \
       ([ -x ${OCAMLBIN}ocamldep.opt ] \
        || which ${OCAMLBIN}ocamldep.opt >>${logfile} 2>&1)
then
    ocamldep="${OCAMLBIN}ocamldep.opt"
else
    ocamldep="${OCAMLBIN}ocamldep"
fi


cppflags="${cppflags} ${Isundials_inc_path} -I${ocaml_path}"
cflags="${cflags} -I${ocaml_path}"

include="<caml/mlvalues.h>"
query="SIZEOF_INT,SIZEOF_LONG,SIZEOF_PTR"
ilp_size=`printf "#include %s\n%s" "${include}" "${query}" \
    | ${CPP} ${cppflags} -P 2>>${logfile} | tail -1`
int_size=`expr "$ilp_size" : "^\([^,]*\),*"`
long_size=`expr "$ilp_size" : "^[^,]*,\([^,]*\),*"`
ptr_size=`expr "$ilp_size" : "^[^,]*,[^,]*,\([^,]*\)"`

if echo ${int_size:-not_found} | grep -q '[^0-9]'; then
    printf "Failed to detect size of \`int'.  This might be a problem\n"
    printf "with detecting your system's C preprocessor.\n\n"
    exit 1
fi
if echo ${long_size:-not_found} | grep -q '[^0-9]'; then
    printf "Failed to detect size of \`long'.  This might be a problem\n"
    printf "with detecting your system's C preprocessor.\n\n"
    exit 1
fi
if echo ${ptr_size:-not found} | grep -q '[^0-9]'; then
    printf "Failed to detect size of pointers.  This might be a problem\n"
    printf "with detecting your system's C preprocessor.\n\n"
    exit 1
fi

if [ "${long_size}" -ne "${ptr_size}" ]; then
    error="${error}\nsizeof (long) does not match sizeof (void*)."
    error="${error}\nStarting with SUNDIALS version 2.5.0, DenseGETRF() and"
    error="${error}\nsimilar functions require arrays of longs as input,"
    error="${error}\nso this binding needs to map C's long * type to some OCaml"
    error="${error}\ntype.  We chose to map it to bigarray with int entries,"
    error="${error}\nwhich gives an overhead-free mapping and a convenient API"
    error="${error}\nfor the user.  As a downside, this requires C's long type"
    error="${error}\nto have the same size as OCaml values, i.e. the same size"
    error="${error}\nas pointers.  The only platform known to violate this"
    error="${error}\nrequirement is Microsoft Visual C on 64-bit Windows"
    error="${error}\n(Win64).  If you must use this binding on 64-bit Windows,"
    error="${error}\ntry compiling SUNDIALS and the binding with Cygwin.  If"
    error="${error}\nusing Cygwin is not an option, write to us and we may"
    error="${error}\nbe able to hack together a workaround for Win64, albeit"
    error="${error}\nwith a slight performance hit."
fi
if [ "${int_size}" -ne 4 ]; then
    error="${error}\nint is not 32 bits on this platform."
    error="${error}\nSome SUNDIALS functions require arrays of ints as input,"
    error="${error}\nso this binding needs to map C's int * type to some OCaml"
    error="${error}\ntype.  We chose to map it to bigarray with int32 entries"
    error="${error}\nwhich gives an overhead-free mapping and a convenient API"
    error="${error}\nfor the user, provided that C's int type is 32 bits.  This"
    error="${error}\nis the case with most, if not all, 32-bit and 64-bit"
    error="${error}\nsystems, and we were not aware of any platforms that are "
    error="${error}\nstill in use which violate this requirement.  However, it"
    error="${error}\nlooks like you have such a platform.  Please inform us"
    error="${error}\nabout your platform and we may be able to hack together a"
    error="${error}\nworkaround, albeit with a slight performance hit."
fi

# Check for opam
if command -v opam >>${logfile} 2>&1; then
    opam_libpath="$(opam config var lib)/"

    # if the opam path is a prefix of the ocaml path, use the former
    case "${ocaml_libpath}" in
	"${opam_libpath}"*)
	    ocaml_libpath="${opam_libpath}";;
    esac

    # install the docs with opam
    if [ "x${docdir}" = x ]; then
	docdir="$(dirname "${opam_libpath}")/doc/sundialsml/"
    fi
else
    opam_libpath=''
fi


# Check if we can compile a direct call to caml_weak_get from C.  Usually we
# can, but it doesn't seem to be supported officially.  Note that a .c + .ml
# pair is infinitely easier to compile portably than a standalone .c file.
test_stem=__configure_test_file__weakget
test_ml_stem=configure_test_ml_file__weakget
cat > $test_stem.c <<EOF
/* This file tests if we can call caml_weak_get() directly from C.  */
#include <caml/mlvalues.h>
#include <caml/memory.h>
#include <caml/alloc.h>

CAMLprim value caml_weak_get (value ar, value n);
CAMLprim value caml_weak_set (value ar, value n, value el);
CAMLprim value caml_weak_create (value len);
#define None_val (Val_int(0))
#define Some_tag 0

CAMLprim value f ()
{
  CAMLparam0 ();
  CAMLlocal3 (table, x, y);

  table = caml_weak_create (Val_int (1));
  x = caml_weak_get (table, Val_int (0));
  if (x != None_val)
    CAMLreturn (Val_int (1));

  y = caml_alloc_small (1, Some_tag);
  Field (y, 0) = Val_int (42);
  caml_weak_set (table, Val_int (0), y);
  x = caml_weak_get (table, Val_int (0));
  if (!Is_block (x) || Tag_val(x) != Some_tag || Field (x,0) != Field(y,0))
    CAMLreturn (Val_int (2));

  caml_weak_set (table, Val_int (0), None_val);
  x = caml_weak_get (table, Val_int (0));
  if (x != None_val)
    CAMLreturn (Val_int (3));

  CAMLreturn (Val_int (0));
}
EOF
test_cmd="${ocamlc} ${test_stem}.c ${test_ml_stem}.ml \
    -o ${test_ml_stem}$XX  -custom"
cat > ${test_ml_stem}.ml <<EOF
(* ${test_cmd} *)
external f : unit -> int = "f"
let _ = exit (f ())
EOF
if eval "${test_cmd}" >>${logfile} 2>&1 && ./${test_ml_stem}$XX; then
    have_weak=1
else
    have_weak=0
    warning="${warning}\n\tCould not compile caml_weak_get; using workaround."
fi
${debug_configure} || \
    rm -f ./${test_stem}.* ./${test_ml_stem}.* ${test_ml_stem}

# Check whether compiler-libs is available
test_ml_stem=configure_test_ml_file__
cat > ${test_ml_stem}.ml <<EOF
Toploop.execute_phrase false Format.err_formatter
  (!Toploop.parse_toplevel_phrase (Lexing.from_string ""))
EOF
# FIXME: is it ever possible that compiler-libs is installed somewhere else?
if ${ocamlc} -I +compiler-libs -c ${test_ml_stem}.ml \
    -o ${test_ml_stem}.cmo >>${logfile} 2>&1; then
    have_compiler_libs=1
    compiler_libs_path=+compiler-libs
else
    # have_compiler_libs should be empty, not 0.
    have_compiler_libs=
    compiler_libs_path=
    warning="${warning}\n\tCould not find compiler-libs; printers will not be"
    warning="${warning}\n\tinstalled by default in the OCaml toplevel."
fi
${debug_configure} || rm -f ./${test_ml_stem}.* ${test_ml_stem}

# Check whether using generic math library (-lm) or not
libm=-lm
if [ $sundials -ge 260 ]; then
    include="\"sundials/sundials_config.h\""
    query="#ifdef SUNDIALS_USE_GENERIC_MATH\n1\n#else\n0\n#endif\n"
    sundials_info=`printf "#include %s\n%b" "${include}" "${query}" \
			| ${CPP} ${cppflags} ${Isundials_inc_path} \
			    -P 2>>${logfile} \
			| grep -v ^$`
    case "${sundials_info}" in
	1) ;;
	0) unset libm ;;
	*) error="${error}\n\terror interpreting sundials_config.h"
	   error="${error} (SUNDIALS_USE_GENERIC_MATH)" ;;
    esac
fi

# Check for shared library support in Sundials/C
enable_shared=1

test_stem=__configure_test_file__sharedlib
test_c_stem=__configure_test_c_file__sharedlib
test_cmd="$CC ${cflags} ${Isundials_inc_path} -o $test_c_stem$XO \
    -c $test_c_stem.c "
test_ml_cmd="${ocamlc} -c $test_stem.ml"
test_mklib_cmd="${OCAMLBIN}ocamlmklib $test_c_stem$XO $test_stem.cmo \
    -o $test_stem -oc $test_stem \
    ${Lsundials_lib_path} -lsundials_cvode -lsundials_nvecserial ${libm}"
echo "/* ${test_cmd} */" > $test_c_stem.c
echo 'void CVode(); void dummy () { CVode (); }' >> $test_c_stem.c
echo "(* ${test_ml_cmd} *)" > $test_stem.ml
echo "(* ${test_mklib_cmd} *)" >> $test_stem.ml
echo 'external dummy : unit -> unit = "dummy" let _ = dummy ()' >> $test_stem.ml
if ! eval ${test_cmd} >$test_stem.log 2>&1 \
    || ! eval ${test_ml_cmd} >> $test_stem.log 2>&1
then
    echo 1>&2 "Panic!  Dummy library failed to compile.  Please report"
    echo 1>&2 "this with ${test_stem}.log attached."
    exit 1
fi

if ! ${test_mklib_cmd} > $test_stem.log 2>&1
then
    warning="${warning}\n\tSundials/C seems to be compiled without shared library support."
    warning="${warning}\n\tSundials/ML may not work in the toplevel."
    enable_shared=
fi

${debug_configure} || \
    rm -f ./lib${test_stem}.* ./dll${test_stem}.* \
	./${test_stem}.* ./${test_c_stem}.*

# Sundials matrices and linear solvers
matrix_libs=
lsolver_libs=

if [ ${sundials} -ge 300 ]; then
    matrix_libs="-lsundials_sunmatrixdense"
    matrix_libs="${matrix_libs} -lsundials_sunmatrixband"
    matrix_libs="${matrix_libs} -lsundials_sunmatrixsparse"

    lsolver_libs="-lsundials_sunlinsoldense"
    lsolver_libs="${lsolver_libs} -lsundials_sunlinsolband"
    lsolver_libs="${lsolver_libs} -lsundials_sunlinsolpcg"
    lsolver_libs="${lsolver_libs} -lsundials_sunlinsolspbcgs"
    lsolver_libs="${lsolver_libs} -lsundials_sunlinsolspfgmr"
    lsolver_libs="${lsolver_libs} -lsundials_sunlinsolspgmr"
    lsolver_libs="${lsolver_libs} -lsundials_sunlinsolsptfqmr"
fi

# Check for LAPACK support
unset lapack_lib
if [ $sundials -gt 0 ]; then
    include="\"sundials/sundials_config.h\""
    if [ $sundials -ge 260 ]; then
	query="#ifdef SUNDIALS_BLAS_LAPACK\n1\n#else\n0\n#endif\n"
    else
	query="SUNDIALS_BLAS_LAPACK"
    fi
    sundials_info=`printf "#include %s\n%b" "${include}" "${query}" \
			| ${CPP} ${cppflags} ${Isundials_inc_path} \
			    -P 2>>${logfile} \
			| grep -v ^$`
    case "${sundials_info}" in
	1) lapack_lib=${LAPACKLIB} ;;
	0) unset lapack_lib ;;
	*) error="${error}\n\terror interpreting sundials_config.h"
	   error="${error} (SUNDIALS_BLAS_LAPACK)" ;;
    esac
fi

if [ "${lapack_lib}" = "" ]; then
    lapack_info=" (without lapack)"
    lapack_enabled=
else
    lapack_info=" (with lapack: ${lapack_lib})"
    lapack_enabled=1
    blas_libs="-lblas"
    if [ ${sundials} -ge 300 ]; then
	lsolver_libs="${lsolver_libs} -lsundials_sunlinsollapackband"
	lsolver_libs="${lsolver_libs} -lsundials_sunlinsollapackdense"
    fi
fi

# Check for monitoring support
monitoring_enabled=
if [ ${sundials} -ge 500 ]; then
    include="\"sundials/sundials_config.h\""
    query="#ifdef SUNDIALS_BUILD_WITH_MONITORING\\n1\\n#else\\n0\\n#endif\\n"
    monitoring_enabled=$(printf "#include %s\\n%b" "${include}" "${query}" \
			| "${CPP}" ${cppflags} ${Isundials_inc_path} \
			    -P 2>>${logfile} \
			| grep -v ^$)
    case "${monitoring_enabled}" in
	1) ;;
	0) ;;
	*) error="${error}\\n\\terror interpreting sundials_config.h"
	   error="${error} (SUNDIALS_BUILD_WITH_MONITORING)" ;;
    esac
else
    monitoring_enabled=0
fi

# Check for SUPERLUMT and KLU
sparse_libs=

klu_enabled=
klu_info="not available"
klu_libs=

superlumt_enabled=
superlumt_info="not available"
superlumt_libs=

if [ $sundials -ge 260 ]; then
    include="\"sundials/sundials_config.h\""
    q1="#ifdef SUNDIALS_KLU\n:KLU:\n#endif\n"
    q2="#ifdef SUNDIALS_SUPERLUMT\n:SUPERLUMT:\n#endif\n"
    sundials_info=`printf "#include %s\n%b%b" "${include}" "${q1}" "${q2}" \
		    | ${CPP} ${cppflags} ${Isundials_inc_path} \
			-P 2>>${logfile} \
		    | grep -v ^$`

    case "${sundials_info}" in
	*:KLU:*)
	    if [ ${enable_klu:-1} -eq 1 ]; then
		klu_enabled=1
		klu_info="installed"
		klu_libs="-lklu -lamd -lcolamd -lbtf -lsuitesparseconfig"
		sparse_libs="$sparse_libs $klu_libs"
		if [ ${sundials} -ge 300 ]; then
		    lsolver_libs="${lsolver_libs} -lsundials_sunlinsolklu"
		fi

                test_stem=__configure_test_c_file__klu
                test_cmd="$CC $test_stem.c ${Iklu_inc_path} ${Lklu_lib_path} ${sparse_libs} -o ${test_stem}${XX}"
                cat > $test_stem.c <<EOF
/* ${test_cmd} */
#include <klu.h>
#include <stddef.h>

int
main()
{
  klu_l_defaults (NULL);
  return 0;
}
EOF
                if ! eval "${test_cmd}" >>${logfile} 2>&1
                then
                    error="${error}\n\tCan't compile with KLU.  You may have to specify KLU_INCLUDE_DIR"
                    error="${error}\n\tand/or KLU_LIBRARY_DIR."
                    error="${error}\n\tSaved test code as ${test_stem}.c"
                    error="${error}\n\tCompilation command was: ${test_cmd}"
                else
		    ${debug_configure} || rm -f ${test_stem} ${test_stem}.*
                fi
	    else
		klu_info='disabled'
	    fi;;
	*)  klu_info="not installed" ;;
    esac

    case "${sundials_info}" in
	*:SUPERLUMT:*)
	    if [ ${enable_superlumt:-1} -eq 1 ]; then
		superlumt_enabled=1
	        superlumt_info="installed"

		if [ "$distribution" = centos ]; then
		    superlumt_libs="-lsuperlumt_d"
		else
		    superlumt_libs="-lsuperlu_mt_PTHREAD -lpthread"
		fi
		sparse_libs="$sparse_libs $superlumt_libs"
		blas_libs="-lblas"
		#sparse_libs="$sparse_libs -lsuperlu_mt_OPENMP -lopenmp"
		if [ ${sundials} -ge 300 ]; then
		    lsolver_libs="${lsolver_libs} -lsundials_sunlinsolsuperlumt"
		fi

		test_stem=__configure_test_c_file__superlumt
		test_cmd="$CC $test_stem.c ${Isuperlumt_inc_path} ${Lsuperlumt_lib_path} ${superlumt_libs} ${blas_libs} ${Lsuperlumt_lib_path} -o ${test_stem}${XX}"
		cat > $test_stem.c <<EOF
/* ${test_cmd} */
#include "slu_mt_ddefs.h"

int main ()
{
  SuperLU_timer_ ();
  return 0;
}
EOF
		if ! eval "${test_cmd}" >>${logfile} 2>&1
                then
                    error="${error}\n\tCan't link to SuperLU_MT.  You may have to specify SUPERLUMT_INCLUDE_DIR"
                    error="${error}\n\tand/or SUPERLUMT_LIBRARY_DIR."
                    error="${error}\n\tSaved test code as ${test_stem}.c"
                    error="${error}\n\tCompilation command was: ${test_cmd}"
                else
		    ${debug_configure} || rm -f ${test_stem} ${test_stem}.*
                fi
	    else
		superlumt_info='disabled'
	    fi;;
	*)  superlumt_info="not installed" ;;
    esac
fi

# Combine all ldflags

ldflags="${ldflags} ${sparse_libs} ${lapack_lib} ${blas_libs}"

if [ "x${mpi_lib_path}" = x ]; then
    for d in /usr/lib64/openmpi; do
	if [ -e "$d/lib/libsundials_nvecparallel.so" ]; then
	    mpi_lib_path="$d/lib"
	    Lmpi_lib_path="-L${mpi_lib_path}"
	fi
	if [ "x${mpicc}" = x -a -x "$d/bin/mpicc" ]; then
	    mpicc="$d/bin/mpicc"
	fi
	if [ "x${mpirun}" = x -a -x "$d/bin/mpirun" ]; then
	    mpirun="$d/bin/mpirun"
	fi
    done
fi

# Parallel features
mpicc=${mpicc:-mpicc}
mpirun=${mpirun:-mpirun}
if [ ${enable_mpi:-1} -eq 1 ]; then
    ocamlmpi_enabled=1

    # Check for OCamlMPI installation
    ocamlmpi="${OCAMLMPI:-${ocaml_libpath}mpi}"
    if [ ! -e "${ocamlmpi}/mpi.cmi" ]; then
	printf "not found: %s\\n" "${ocamlmpi}/mpi.cmi" >>${logfile}
	ocamlmpi="${ocaml_libpath}site-lib/mpi"
	if [ ! -e "${ocamlmpi}/mpi.cmi" ]; then
	    printf "not found: %s\\n" "${ocamlmpi}/mpi.cmi" >>${logfile}
	    ocamlmpi="${opam_libpath}mpi"
	    if [ ! -e "${ocamlmpi}/mpi.cmi" ]; then
		printf "not found: %s\\n" "${ocamlmpi}/mpi.cmi" >>${logfile}
		ocamlmpi='NOT FOUND'
		ocamlmpi_enabled=
	    fi
	fi
    fi

    # Check for nvector_parallel installation
    test_stem=__configure_test_file__parallel
    test_cmd="$mpicc -o $test_stem$XX ${Isundials_inc_path} $test_stem.c \
	 ${Lsundials_lib_path} -lsundials_cvode -lsundials_nvecparallel \
	 ${Lsuperlumt_lib_path} ${Lklu_lib_path} ${libm} ${sparse_libs} \
	 ${blas_libs} ${lapack_lib}"
    cat > $test_stem.c <<EOF
/* $test_cmd */
#include <stdio.h>
#include <nvector/nvector_parallel.h>
int main (int argc, char *argv[])
{
  MPI_Comm dummy;
  (void)N_VNewEmpty_Parallel (dummy, 0, 0);
  return 0;
}
EOF
    if ! eval "${test_cmd}" >>${logfile} 2>&1;
    then
        sundialsmpi_info='not installed'
        ocamlmpi_enabled=
    else
        sundialsmpi_info='installed'
    fi
    ${debug_configure} || rm -f ./$test_stem.* ./$test_stem$XX
else
    sundialsmpi_info='disabled'
    ocamlmpi_enabled=
    ocamlmpi='DISABLED (no parallel features)'
fi

if [ "x${ocamlmpi_enabled}" = x ]; then
    ocamlmpi_path=''
else
    ocamlmpi_path="$ocamlmpi"
    ocamlmpi="${ocamlmpi} (compiler: $mpicc)"
fi

serial_nvec_libs=-lsundials_nvecserial

# Check for nvector_pthread installation
nvecpthreads_info='not available'
nvecpthreads_enabled=
if [ $sundials -ge 260 ]; then
    test_stem=__configure_test_file__nvecpthreads
    cat > $test_stem.c <<EOF
#include <stdio.h>
#include <nvector/nvector_pthreads.h>
int main (int argc, char *argv[])
{
  (void)N_VNew_Pthreads (1000, 10);
  return 0;
}
EOF
    if ! $CC -o $test_stem$XX ${Isundials_inc_path} $test_stem.c \
	 ${Lsundials_lib_path} -lsundials_nvecpthreads -lpthread ${libm} \
       >>${logfile} 2>&1;
    then
	nvecpthreads_info='not installed'
    else
	nvecpthreads_info='installed'
	nvecpthreads_enabled=1
	serial_nvec_libs="$serial_nvec_libs -lsundials_nvecpthreads"
    fi
    ${debug_configure} || rm -f ./$test_stem.* ./$test_stem$XX
fi


# Check for nvector_openmp installation
nvecopenmp_info='not available'
nvecopenmp_enabled=
if [ $sundials -ge 260 ]; then
    test_stem=__configure_test_file__nvecopenmp
    cat > $test_stem.c <<EOF
#include <stdio.h>
#include <nvector/nvector_openmp.h>
int main (int argc, char *argv[])
{
  (void)N_VNew_OpenMP (1000, 10);
  return 0;
}
EOF
    if ! $CC -o $test_stem$XX ${Isundials_inc_path} $test_stem.c \
	 ${Lsundials_lib_path} -lsundials_nvecopenmp ${libm} \
       >>${logfile} 2>&1;
    then
	nvecopenmp_info='not installed'
    else
	nvecopenmp_info='installed'
	nvecopenmp_enabled=1
	serial_nvec_libs="$serial_nvec_libs -lsundials_nvecopenmp"

        # Determine the C compiler flag for enabling OpenMP.
        if [ "x$cflags_openmp" = x ]; then
            cat > $test_stem.c <<EOF
#include <stdio.h>
void omp_set_num_threads (int);
int main (int argc, char *argv[])
{
  int i;
  omp_set_num_threads(argc);
  #pragma omp for
  for (i = 0; i <= argc; ++i)
    printf ("Making extra sure omp_set_num_threads() isn't optimized away");
  return 0;
}
EOF
            # Credit: List of known flags borrowed from ax_openmp.m4
            for flag in -fopenmp -openmp -mp -xopenmp -omp -qsmp=omp
            do
                if $CC $CFLAGS $flag $test_stem.c -o $test_stem$XX \
                       >>${logfile} 2>&1
                then
                    cflags_openmp=$flag
                    break
                fi
            done
            if [ "x$cflags_openmp" = x ]; then
                warning="${warning}\n\tCouldn't determine C compiler flag for OpenMP.  The library should compile"
                warning="${warning}\n\tcorrectly with OpenMP enabled, but some examples may fail to compile."
                warning="${warning}\n\tTo fix this warning, re-configure with CFLAGS_OPENMP set to the appropriate"
		warning="${warning}\n\tflag, or use CC= to specify a compiler that supports OpenMP."
            fi
        fi
    fi
    ${debug_configure} || rm -f ./$test_stem.* ./$test_stem$XX
fi

# Sundials examples directory
if [ "x$EXAMPLESROOT" = x ]; then
    # Try to infer it from the include path.
    include="\"sundials/sundials_config.h\""
    prefix_info=`printf "#include %s\n" "${include}" \
	| ${CPP} ${cppflags} ${Isundials_inc_path} -E 2>>${logfile} \
	| sed -ne "s/^.*\"\(.*\)\/include\/sundials\/sundials_config.h\".*$/\1/p" \
	| head -n 1`

    if [ "x${prefix_info}" != x ]; then
	EXAMPLESROOT="${prefix_info}/examples"
    elif [ "x${sundials_lib_path}" = x ]; then
	EXAMPLESROOT=${prefix}examples
    else
	# Try to infer it from LIB_PATH.
	EXAMPLESROOT=`echo ${sundials_lib_path} | sed -e 's/lib$/examples/'`
    fi
fi
# Check if it's valid.
if [ -d "$EXAMPLESROOT/cvode/serial" ]; then
    examples_info="$EXAMPLESROOT"
else
    examples_info="NOT FOUND"
    EXAMPLESROOT=

    # try a few other locations since there's nothing to lose
    for d in /usr/share/doc/libsundials-serial-dev/examples; do
	if [ -d "$d/cvode/serial" ]; then
	    EXAMPLESROOT="$d"
	    examples_info="$EXAMPLESROOT"
	fi
    done
fi


# MathJax
# Check presence of MathJax.js if absolute path.
if echo "${mathjax}" | grep -q '[a-zA-Z][-+.a-zA-Z0-9]*://'; then
    mathjax_known_online=
    mathjax_known_local=
elif [ "x${mathjax}" = x ]; then
    mathjax_known_online=1
    mathjax_known_local=
    mathjax=https://cdn.mathjax.org/mathjax/latest/
elif ! [ -r "${mathjax}/MathJax.js" ]; then
    error="${error}\n\t${mathjax}/MathJax.js not found or not readable"
else
    mathjax_known_online=
    mathjax_known_local=
    if [ "x${mathjax}" = "x${mathjax}" ] && \
        echo "${mathjax}" | grep -q '^[^/]';
    then
        warning="${warning}\n\tYour MATHJAX_PATH looks like a relative path."
        warning="${warning}\n\tIt may not work after a make install."
        # keep original ${mathjax}
        mathjax_known_local=1
    else
        mathjax=`echo "${mathjax}" | sed -e 's@^/@file:///@'`
        if echo "${mathjax}" | grep -q '^file://'; then
            mathjax_known_local=1
        fi
    fi
fi

# OCaml Graphics
# Check for the optional OCaml graphics library
if [ "x$OCAML_GRAPHICS" != x ] && [ ! -f "$OCAML_GRAPHICS/graphics.cma" ]; then
    warning="${warning}\n\tYour OCAML_GRAPHICS path does not contain graphics.cma."
    warning="${warning}\n\tThe result of ocamlfind will be used instead."
fi

if [ "x$OCAML_GRAPHICS" = x ] || [ ! -f "$OCAML_GRAPHICS/graphics.cma" ]; then
    OCAML_GRAPHICS="$(ocamlfind query graphics 2> /dev/null)"
fi

if [ "x$OCAML_GRAPHICS" != x ] && [ -f "$OCAML_GRAPHICS/graphics.cma" ]; then
    ocaml_graphics_path="$OCAML_GRAPHICS"
else
    ocaml_graphics_path=
fi

# Show a summary

LOG=config.log

printf "\nConfiguration (${version}p${versionp})\n-----------------------\n" \
                                                                       > ${LOG}
printf "  OCaml                 ${ocaml_path}${ocaml_version_info}${ocaml_tweaks}\n" \
								      >> ${LOG}
printf "  Sundials              ${sundials_version}${lapack_info}\n"  >> ${LOG}
printf "    -parallel           ${sundialsmpi_info}\n"	              >> ${LOG}
printf "    -nvector: pthreads  ${nvecpthreads_info}\n"	              >> ${LOG}
printf "    -nvector: openmp    ${nvecopenmp_info}\n"                 >> ${LOG}
printf "    -SuperLU_MT         ${superlumt_info}\n"	              >> ${LOG}
printf "    -KLU                ${klu_info}\n"                        >> ${LOG}
printf "    -examples           ${examples_info}\n"                   >> ${LOG}
printf "  OCamlMPI              ${ocamlmpi}\n"                        >> ${LOG}
printf "  MathJax (for docs)    ${mathjax}"                           >> ${LOG}
if [ "x${mathjax_known_online}" = x1 ]; then
    printf " (rendering needs network)\n"                             >> ${LOG}
elif [ "x${mathjax_known_local}" = x1 ]; then
    printf " (offline rendering)\n"                                   >> ${LOG}
else
    printf "\n"	                                                      >> ${LOG}
fi
printf "\n"                                                           >> ${LOG}
printf "  Architecture          ${arch}\n"                            >> ${LOG}
[ "x$enable_debug" = x1 ] && printf "  Debugging\t\tENABLED\n"        >> ${LOG}
printf "\n"                                                           >> ${LOG}
printf "Installation paths\n"                                         >> ${LOG}
printf "  prefix:               ${prefix}\n"                          >> ${LOG}
printf "  libdir:               ${libdir:-${ocaml_libpath}}\n"        >> ${LOG}
printf "  stubdir:              ${stubdir:-${ocaml_libpath}stublibs/}\n" >> ${LOG}
if [ ${install_docs:-1} -eq 1 ]; then
    printf "  docdir:               ${docdir:-${prefix}share/doc/sundialsml/}\n" >> ${LOG}
fi
printf "\n"                                                           >> ${LOG}

if [ -n "${other_tweaks}" ]; then
    printf "Non-standard configuration:${other_tweaks}\n\n"	      >> ${LOG}
fi

if [ -n "${error}" ]; then
    printf "Some errors occurred during configuration:${error}\n\n"   >> ${LOG}
    cat ${LOG}
    exit 1
elif [ -n "${warning}" ]; then
    printf "Warnings:${warning}\n\n"                                  >> ${LOG}
fi

if [ ! -f config.in ]; then
    # Allow ./configure without source files (for troubleshooting)
    printf "Not in source directory: skipping build file generation.\n" >> ${LOG}
    cat ${LOG}
    exit 0
fi

cat ${LOG}

# Produce configuration files for Sundials/ML build

(printf "# # # THIS FILE IS GENERATED AUTOMATICALLY BY CONFIGURE # # #\n"; \
 sed -e "s#@prefix@#${prefix}#;
	 s#@configure_command@#${configure_command}#;
	 s#@version@#${version}#;
	 s#@versionp@#${versionp}#;
	 s#@sundials_at_least_4_0_0@#${sundials_at_least_4_0_0}#;
	 s#@sundials_at_least_3_2_0@#${sundials_at_least_3_2_0}#;
	 s#@sundials_at_least_3_1_2@#${sundials_at_least_3_1_2}#;
	 s#@sundials_at_least_3_0@#${sundials_at_least_3_0}#;
	 s#@sundials_at_least_2_7@#${sundials_at_least_2_7}#;
	 s#@sundials_at_least_2_6@#${sundials_at_least_2_6}#;
	 s#@sundials_at_least_2_5@#${sundials_at_least_2_5}#;
	 s#@libdir@#${libdir:-${ocaml_libpath}}#;
	 s#@stubdir@#${stubdir:-${ocaml_libpath}stublibs/}#;
	 s#@docdir@#${docdir:-${prefix}share/doc/sundialsml/}#;
	 s#@install_docs@#${install_docs:-1}#;
	 s#@cflags@#${cflags}#;
	 s#@cppflags@#${cppflags}#;
	 s#@cflags_openmp@#${cflags_openmp}#;
	 s#@ml_cppflags@#${ml_cppflags}#;
	 s#@ldflags@#${ldflags}#;
	 s#@sundials_lib_path@#${Lsundials_lib_path} ${Lmpi_lib_path}#;
	 s#@sundials_inc_path@#${Isundials_inc_path}#;
	 s#@superlumt_lib_path@#${Lsuperlumt_lib_path}#;
	 s#@superlumt_inc_path@#${Isuperlumt_inc_path}#;
	 s#@klu_lib_path@#${Lklu_lib_path}#;
	 s#@klu_inc_path@#${Iklu_inc_path}#;
	 s#@arkode_enabled@#${arkode_enabled}#;
	 s#@link_sundials_arkode@#${Lsundials_arkode}#;
	 s#@arkode_mlobj_main@#${arkode_mlobj_main}#;
	 s#@arkode_cobj_main@#${arkode_cobj_main}#;
	 s#@arkode_mlobj_bbd@#${arkode_mlobj_bbd}#;
	 s#@arkode_cobj_bbd@#${arkode_cobj_bbd}#;
	 s#@arkode_cobj_sens@#${arkode_cobj_sens}#;
	 s#@arkode_subdir@#${arkode_subdir}#;
	 s#@ocamlflags@#${ocamlflags}#;
	 s#@ocamloptflags@#${ocamloptflags}#;
	 s#@ocamlmklibflags@#${ocamlmklibflags}#;
	 s#@bounds_checking@#${bounds_checking}#;
	 s#@ocaml_version@#${ocaml_version}#;
	 s#@ocamlc@#${ocamlc}#;
	 s#@ocamlopt@#${ocamlopt}#;
	 s#@ocamldoc@#${ocamldoc}#;
	 s#@ocamldoc_plugin@#${ocamldoc_plugin}#;
	 s#@ocamldep@#${ocamldep}#;
	 s#@ocamlmpi_path@#${ocamlmpi_path}#;
	 s#@ocamlmpi_enabled@#${ocamlmpi_enabled}#;
	 s#@have_compiler_libs@#${have_compiler_libs}#;
	 s#@compiler_libs_path@#${compiler_libs_path}#;
	 s#@enable_shared@#${enable_shared}#;
	 s#@lapack_enabled@#${lapack_enabled}#;
	 s#@klu_enabled@#${klu_enabled}#;
	 s#@superlumt_enabled@#${superlumt_enabled}#;
	 s#@nvecpthreads_enabled@#${nvecpthreads_enabled}#;
	 s#@nvecopenmp_enabled@#${nvecopenmp_enabled}#;
	 s#@serial_nvec_libs@#${serial_nvec_libs}#;
	 s#@sparse_libs@#${sparse_libs}#;
	 s#@matrix_libs@#${matrix_libs}#;
	 s#@lsolver_libs@#${lsolver_libs}#;
	 s#@cc@#${CC}#;
	 s#@cpp@#${CPP}#;
	 s#@mpicc@#${mpicc}#;
	 s#@mpirun@#${mpirun}#;
	 s#@mathjax@#${mathjax%/}#;
	 s#@ocaml_graphics_path@#${ocaml_graphics_path%/}#;
	 s#@c_suppress_warnings@#${c_suppress_warnings}#;
	 s#@XA@#${XA}#;
	 s#@XO@#${XO}#;
	 s#@XS@#${XS}#;
	 s#@EXAMPLESROOT@#${EXAMPLESROOT}#;
	 s#@OCAMLBIN@#${OCAMLBIN}#;" config.in) > config

printf "/* Automatically generated file - don't edit!  See configure.  */\\n"\
     > src/config.h
{ printf "#ifndef __SUNDIALS_CONFIG_H__\\n";\
  printf "#define __SUNDIALS_CONFIG_H__\\n";\
  printf "#include <caml/version.h>\\n";\
  printf "#define HAVE_WEAK %d\\n" "${have_weak}";\
  printf "#define SUNDIALS_ML_SAFE %d\\n" "${bounds_checking}";\
} >> src/config.h
if [ "x${lapack_enabled}" = x1 ]; then
printf "#define SUNDIALS_ML_LAPACK\\n" >> src/config.h
fi
if [ "x${klu_enabled}" = x1 ]; then
printf "#define SUNDIALS_ML_KLU\\n" >> src/config.h
fi
if [ "x${superlumt_enabled}" = x1 ]; then
printf "#define SUNDIALS_ML_SUPERLUMT\\n" >> src/config.h
fi
if [ "x${nvecpthreads_enabled}" = x1 ]; then
printf "#define SUNDIALS_ML_PTHREADS\\n" >> src/config.h
fi
if [ "x${nvecopenmp_enabled}" = x1 ]; then
printf "#define SUNDIALS_ML_OPENMP\\n" >> src/config.h
fi
printf "#define SUNDIALS_LIB_VERSION %d\\n" "${sundials}" >> src/config.h
if [ "${sundials_indextype}" -eq 64 ]; then
printf "#define Index_val(x) Long_val(x)\\n" >> src/config.h
printf "#define Val_index(x) Val_long(x)\\n" >> src/config.h
printf "#define CAML_BA_INDEX CAML_BA_INT64\\n" >> src/config.h
else
printf "#define Index_val(x) Int_val(x)\\n" >> src/config.h
printf "#define Val_index(x) Val_int(x)\\n" >> src/config.h
printf "#define CAML_BA_INDEX CAML_BA_INT32\\n" >> src/config.h
fi
printf "#endif /* __SUNDIALS_CONFIG_H__ */\\n" >> src/config.h

# Generate sundials/sundials_configuration.ml
echo "(* Automatically generated file - don't edit!  See configure.  *)"\
    > src/sundials/sundials_configuration.ml
versiondigits=`echo ${version} | sed -e 's/\\./,/g'`
echo "let version = ${versiondigits},${versionp}"\ >> src/sundials/sundials_configuration.ml
sundials_versiondigits=`echo ${sundials_version} | sed -e 's/\\./,/g'`
echo "let sundials_version = ${sundials_versiondigits}"\ >> src/sundials/sundials_configuration.ml
if [ "x${lapack_enabled}" = x ]; then
    echo "let lapack_enabled = false" >> src/sundials/sundials_configuration.ml
else
    echo "let lapack_enabled = true"  >> src/sundials/sundials_configuration.ml
fi
if [ "x${monitoring_enabled}" = x1 ]; then
    echo "let monitoring_enabled = true" >> src/sundials/sundials_configuration.ml
else
    echo "let monitoring_enabled = false"  >> src/sundials/sundials_configuration.ml
fi
if [ "x${ocamlmpi_enabled}" = x ]; then
    echo "let mpi_enabled = false" >> src/sundials/sundials_configuration.ml
else
    echo "let mpi_enabled = true"  >> src/sundials/sundials_configuration.ml
fi
if [ "x${klu_enabled}" = x ]; then
    echo "let klu_enabled = false" >> src/sundials/sundials_configuration.ml
else
    echo "let klu_enabled = true"  >> src/sundials/sundials_configuration.ml
fi
if [ "x${superlumt_enabled}" = x ]; then
    echo "let superlumt_enabled = false" >> src/sundials/sundials_configuration.ml
else
    echo "let superlumt_enabled = true"  >> src/sundials/sundials_configuration.ml
fi
if [ "x${nvecpthreads_enabled}" = x ]; then
    echo "let nvecpthreads_enabled = false" >> src/sundials/sundials_configuration.ml
else
    echo "let nvecpthreads_enabled = true"  >> src/sundials/sundials_configuration.ml
fi
if [ "x${nvecopenmp_enabled}" = x ]; then
    echo "let nvecopenmp_enabled = false" >> src/sundials/sundials_configuration.ml
else
    echo "let nvecopenmp_enabled = true"  >> src/sundials/sundials_configuration.ml
fi
if [ "x${bounds_checking}" = x0 ]; then
    echo "let safe = false" >> src/sundials/sundials_configuration.ml
else
    echo "let safe = true"  >> src/sundials/sundials_configuration.ml
fi

# Generate sundials/sundials_Index.ml
echo "(* Automatically generated file - don't edit!  See configure.  *)"\
    > src/sundials/sundials_Index.ml
if [ "${sundials_indextype}" -eq 64 ]; then
    echo "include Int64" >> src/sundials/sundials_Index.ml
    echo "type index_elt = Bigarray.int64_elt" >> src/sundials/sundials_Index.ml
else
    echo "include Int32" >> src/sundials/sundials_Index.ml
    echo "type index_elt = Bigarray.int32_elt" >> src/sundials/sundials_Index.ml
fi

# Generate sundials/sundials_Index.mli
echo "(* Automatically generated file - don't edit!  See configure.  *)"\
    > src/sundials/sundials_Index.mli
echo "(** Index values for sparse matrices. *)"\
    > src/sundials/sundials_Index.mli
if [ "${sundials_indextype}" -eq 64 ]; then
    echo "include module type of Int64" >> src/sundials/sundials_Index.mli
    echo "type index_elt = Bigarray.int64_elt" >> src/sundials/sundials_Index.mli
else
    echo "include module type of Int32" >> src/sundials/sundials_Index.mli
    echo "type index_elt = Bigarray.int32_elt" >> src/sundials/sundials_Index.mli
fi

${debug_configure} && (echo "#----${logfile}:"; cat ${logfile})

exit 0
