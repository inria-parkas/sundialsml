# vim: ft=make

# Configured with:
CONFIG_COMMAND ?= @configure_command@

VERSION = @version@
VERSIONP = @versionp@

CVODE_DOC_ROOT_DEFAULT  = https://computation.llnl.gov/casc/sundials/documentation/cv_guide/
CVODES_DOC_ROOT_DEFAULT = https://computation.llnl.gov/casc/sundials/documentation/cvs_guide/
ARKODE_DOC_ROOT_DEFAULT  = https://computation.llnl.gov/casc/sundials/documentation/ark_guide/
IDA_DOC_ROOT_DEFAULT    = https://computation.llnl.gov/casc/sundials/documentation/ida_guide/
IDAS_DOC_ROOT_DEFAULT   = https://computation.llnl.gov/casc/sundials/documentation/idas_guide/
KINSOL_DOC_ROOT_DEFAULT = https://computation.llnl.gov/casc/sundials/documentation/kin_guide/
OCAML_DOC_ROOT_DEFAULT  = http://caml.inria.fr/pub/docs/manual-ocaml/libref/
MATHJAX_URL_DEFAULT     = @mathjax@

CC = @cc@
CPP= @cpp@
CFLAGS += @cflags@
LDFLAGS += @ldflags@
CPPFLAGS += @cppflags@
C_SUPPRESS_WARNINGS = @c_suppress_warnings@

# FIXME: gcc-dependent
ML_CPPFLAGS = @ml_cppflags@

LAPACK_ENABLED=@lapack_enabled@

MPICC = @mpicc@
MPIRUN = @mpirun@
MPI_ENABLED=@ocamlmpi_enabled@

MPI_LIBLINK= -lsundials_nvecparallel

LIB_PATH = @sundials_lib_path@ @superlumt_lib_path@
INC_PATH = @sundials_inc_path@
CVODE_LDFLAGS = -lsundials_cvode @serial_nvec_libs@ @sparse_libs@ -lm $(LDFLAGS)
CVODE_CFLAGS = $(INC_PATH) $(CFLAGS)
CVODES_LDFLAGS = -lsundials_cvodes @serial_nvec_libs@ @sparse_libs@ -lm $(LDFLAGS)
CVODES_CFLAGS = $(INC_PATH) $(CFLAGS)
ARKODE_LDFLAGS = @link_sundials_arkode@ @serial_nvec_libs@ @sparse_libs@ -lm $(LDFLAGS)
ARKODE_CFLAGS = $(INC_PATH) $(CFLAGS)
IDA_LDFLAGS = -lsundials_ida @serial_nvec_libs@ @sparse_libs@ -lm $(LDFLAGS)
IDA_CFLAGS = $(INC_PATH) $(CFLAGS)
IDAS_LDFLAGS = -lsundials_idas @serial_nvec_libs@ @sparse_libs@ -lm $(LDFLAGS)
IDAS_CFLAGS = $(INC_PATH) $(CFLAGS)
KINSOL_LDFLAGS = -lsundials_kinsol @serial_nvec_libs@ @sparse_libs@ -lm $(LDFLAGS)
KINSOL_CFLAGS = $(INC_PATH) $(CFLAGS)

ARKODE_MLOBJ_MAIN = @arkode_mlobj_main@
ARKODE_COBJ_MAIN = @arkode_cobj_main@
ARKODE_MLOBJ_BBD = @arkode_mlobj_bbd@
ARKODE_COBJ_BBD = @arkode_cobj_bbd@

SLS_ML_XO = @sls_ml_xo@
SLS_CMO = @sls_cmo@

PTHREADS_ENABLED = @nvecpthreads_enabled@
NVECPTHREADS_ML_XO = @nvecpthreads_ml_xo@
NVECPTHREADS_CMO = @nvecpthreads_cmo@

OPENMP_ENABLED = @nvecopenmp_enabled@
NVECOPENMP_ML_XO = @nvecopenmp_ml_xo@
NVECOPENMP_CMO = @nvecopenmp_cmo@
CFLAGS_OPENMP = @cflags_openmp@

KLU_ENABLED = @klu_enabled@
KLU_COBJ_SENS = @klu_cobj_sens@
KLU_COBJ_NO_SENS = @klu_cobj_no_sens@
KLU_MLOBJ_MAIN = @klu_mlobj_main@
KLU_MLOBJ_SENS = @klu_mlobj_sens@

SUPERLUMT_ENABLED = @superlumt_enabled@
SUPERLUMT_COBJ_SENS = @superlumt_cobj_sens@
SUPERLUMT_COBJ_NO_SENS = @superlumt_cobj_no_sens@
SUPERLUMT_MLOBJ_MAIN = @superlumt_mlobj_main@
SUPERLUMT_MLOBJ_SENS = @superlumt_mlobj_sens@

define common
  $(eval seen :=)
  $(eval dups :=)
  $(foreach _,$1,$(if $(filter $_,${seen}),
      $(if $(filter $_,${dups}),,$(eval dups += $_)),
      $(eval seen += $_)))
  ${dups}
endef

OCAMLC ?= @ocamlc@
OCAMLFLAGS = -annot @ocamlflags@
OCAML_INCLUDE := $(shell $(OCAMLC) -where)
OCAML_ALL_LIBLINK = $(strip $(call common, $(CVODE_LDFLAGS) $(CVODES_LDFLAGS) \
		    			   $(ARKODE_LDFLAGS)		      \
					   $(IDA_LDFLAGS) $(IDAS_LDFLAGS)     \
					   $(KINSOL_LDFLAGS)))
OCAML_CVODE_LIBLINK  = $(filter-out $(OCAML_ALL_LIBLINK), $(CVODE_LDFLAGS))
OCAML_CVODES_LIBLINK = $(filter-out $(OCAML_ALL_LIBLINK), $(CVODES_LDFLAGS))
OCAML_ARKODE_LIBLINK = $(filter-out $(OCAML_ALL_LIBLINK), $(ARKODE_LDFLAGS))
OCAML_IDA_LIBLINK    = $(filter-out $(OCAML_ALL_LIBLINK), $(IDA_LDFLAGS))
OCAML_IDAS_LIBLINK   = $(filter-out $(OCAML_ALL_LIBLINK), $(IDAS_LDFLAGS))
OCAML_KINSOL_LIBLINK = $(filter-out $(OCAML_ALL_LIBLINK), $(KINSOL_LDFLAGS))
OCAML_MPI_LIBLINK = -lsundials_nvecparallel
OCAML_3X = @ocaml_3x@

OCAML ?= @OCAMLBIN@ocaml

OCAMLMPI ?= @ocamlmpi_path@

CAMLP4OF= @OCAMLBIN@camlp4of
CAMLP4ORF= @OCAMLBIN@camlp4orf

PKGDIR = @libdir@sundialsml/
STUBDIR= @stubdir@

DOCDIR = @docdir@
INSTALL_DOCS = @install_docs@

OCAMLOPT ?= @ocamlopt@
OCAMLOPTFLAGS = @ocamloptflags@

OCAMLDEP ?= @ocamldep@
OCAMLDOC ?= @ocamldoc@
OCAMLDOC_PLUGIN ?= @ocamldoc_plugin@

OCAMLMKLIB ?= @OCAMLBIN@ocamlmklib -ocamlc "$(OCAMLC) $(OCAMLFLAGS)" -ocamlopt "$(OCAMLOPT) $(OCAMLOPTFLAGS)"
OCAMLMKLIBFLAGS ?= @ocamlmklibflags@ -verbose

ENABLE_SHARED = @enable_shared@

GNUPLOT = gnuplot

EXAMPLESROOT = @EXAMPLESROOT@

SUBDIRS = sundials nvectors lsolvers cvode cvodes ida idas \
	  @arkode_subdir@ kinsol

XA=@XA@
XO=@XO@
XS=@XS@

CP     ?= cp
RM     ?= rm
CAT    ?= cat
ECHO   ?= echo
MKDIR  ?= mkdir -p
RMDIR  ?= rmdir
SED    ?= sed

MPI_DIRECTORIES = @ocamlmpi_path@
DIRECTORIES =

MPI_INCLUDES = $(MPI_DIRECTORIES:%=-I %)
INCLUDES = $(DIRECTORIES:%=-I %)

OBJ_OPT = $(OBJ:.cmo=.cmx)

